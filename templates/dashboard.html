<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .dashboard { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: #343a40; color: white; padding: 20px; }
        .sidebar-header { text-align: center; margin-bottom: 20px; }
        .sidebar-header img { width: 50px; margin-bottom: 10px; }
        .nav-item { padding: 10px; cursor: pointer; border-radius: 5px; margin-bottom: 5px; display: flex; align-items: center; }
        .nav-item:hover { background: rgba(255, 255, 255, 0.1); }
        .nav-item.active { background: #dc3545; }
        .nav-item i { margin-right: 10px; }
        .content { flex: 1; padding: 20px; background: #f8f9fc; }
        .card { border: none; border-radius: 0.35rem; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1); }
        .alert { border-radius: 0.35rem; }
        body { font-family: 'Poppins', sans-serif; }
        .mood-button { margin: 5px; font-weight: 500; }
        .mood-button.active { opacity: 1; font-weight: 700; }
        .mood-button:not(.active) { opacity: 0.6; }
        .song-card { width: 200px; margin-right: 15px; }
        .song-card img { width: 100%; height: 120px; object-fit: cover; border-radius: 0.35rem; }
        .song-card-body { padding: 10px; text-align: center; }
        .song-title { font-size: 0.9rem; font-weight: 500; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-artist { font-size: 0.8rem; color: #6c757d; margin-bottom: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-actions { display: flex; flex-direction: column; gap: 5px; }
        .play-btn, .add-to-fav-btn { font-size: 0.8rem; padding: 5px; }
        .horizontal-scroll { display: flex; overflow-x: auto; padding-bottom: 10px; }
        .horizontal-scroll::-webkit-scrollbar { height: 8px; }
        .horizontal-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .search-section { margin-bottom: 20px; }
        .search-form { display: flex; gap: 10px; }
        .video-modal .modal-content { background: #fff; border-radius: 0.35rem; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .error-message { color: #dc3545; font-style: italic; text-align: center; }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo">
                <h2>MoodBeats</h2>
            </div>
            <div class="nav-item {% if active_page == 'loginhome' %}active{% endif %}" onclick="window.location.href='{{ url_for('loginhome') }}'">
                <i class="fas fa-home"></i>
                <span>Back to Home</span>
            </div>
            <div class="nav-item {% if active_page == 'dashboard' %}active{% endif %}" onclick="window.location.href='{{ url_for('dashboard') }}'">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </div>
            <div class="nav-item {% if active_page == 'favorites' %}active{% endif %}" onclick="window.location.href='{{ url_for('favorites') }}'">
                <i class="fas fa-heart"></i>
                <span>Favorite Songs</span>
            </div>
            <div class="nav-item {% if active_page == 'playlists' %}active{% endif %}" onclick="window.location.href='{{ url_for('playlists') }}'">
                <i class="fas fa-list"></i>
                <span>My Playlists</span>
            </div>
            <div class="nav-item {% if active_page == 'history' %}active{% endif %}" onclick="window.location.href='{{ url_for('history') }}'">
                <i class="fas fa-history"></i>
                <span>Mood History</span>
            </div>
            <div class="nav-item {% if active_page == 'settings' %}active{% endif %}" onclick="window.location.href='{{ url_for('settings') }}'">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </div>
            <div class="nav-item" onclick="return confirm('Are you sure you want to logout?') && (window.location.href='{{ url_for('logout') }}')">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </div>
        </div>
        <div class="content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <h2>Welcome, {{ username }}!</h2>
            <div class="row">
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5>Favorite Songs</h5>
                            <p class="h3">{{ total_favorites }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5>Total Playlists</h5>
                            <p class="h3">{{ total_playlists }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5>Total Songs</h5>
                            <p class="h3">{{ total_songs }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card mb-4 search-section">
                <div class="card-body">
                    <h5>Search Songs</h5>
                    <div class="search-form">
                        <input type="text" id="song-search" class="form-control" placeholder="Search songs by title or artist...">
                        <button class="btn btn-primary" onclick="searchSongs()">Search</button>
                    </div>
                    <div id="song-search-results" class="mt-3"></div>
                </div>
            </div>
            <div class="card mb-4">
                <div class="card-body">
                    <h5>Explore by Mood</h5>
                    <div class="mb-3">
                        {% for mood, data in mood_queries.items() %}
                            <button class="btn mood-button {% if loop.first %}active{% endif %}" style="background-color: {{ data.color }}; color: white;" onclick="showMoodSongs('{{ mood }}', '{{ data.color }}')">
                                {{ mood.capitalize() }}
                            </button>
                        {% endfor %}
                    </div>
                    <div id="song-display"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Modal -->
    <div class="modal fade video-modal" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="videoModalLabel">Playing Song</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="video-container">
                        <iframe id="youtubePlayer" src="" frameborder="0" allowfullscreen></iframe>
                        <p id="errorMessage" class="error-message d-none">This URL is not a valid YouTube video link.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Store mood songs data from server
        const moodSongs = {{ mood_songs | tojson }};
        let activeMood = null;

        // Initialize default mood on page load
        document.addEventListener('DOMContentLoaded', () => {
            const firstMood = Object.keys(moodSongs)[0];
            if (firstMood) {
                const firstMoodData = {{ mood_queries | tojson }}[firstMood];
                activeMood = firstMood;
                showMoodSongs(firstMood, firstMoodData.color, false);
            }
        });

        function showMoodSongs(mood, moodColor, fetchSongs = true) {
            // Only set activeMood to null when switching moods
            if (activeMood !== mood) {
                activeMood = null;
            }
            activeMood = mood;

            // Update button states
            document.querySelectorAll('.mood-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.trim().toLowerCase() === mood) {
                    btn.classList.add('active');
                }
            });

            // Clear search results
            document.getElementById('song-search-results').innerHTML = '';
            document.getElementById('song-search').value = '';

            // Get songs for the selected mood from preloaded data
            const songs = moodSongs[mood] || [];
            const songDisplay = document.getElementById('song-display');

            // Render songs
            songDisplay.innerHTML = songs.length ? `
                <h6>${mood.charAt(0).toUpperCase() + mood.slice(1)} Songs</h6>
                <div class="horizontal-scroll">
                    ${songs.slice(0, 5).map(song => `
                        <div class="card song-card">
                            <img src="${song.image}" alt="${song.name}" class="card-img-top">
                            <div class="song-card-body">
                                <div class="song-title">${song.name}</div>
                                <div class="song-artist">${song.artist}</div>
                                <div class="song-actions">
                                    <button class="btn btn-sm play-btn" style="background-color: ${moodColor}; color: white;" data-bs-toggle="modal" data-bs-target="#videoModal" data-video-url="${song.url.replace(/'/g, "\\'")}" onclick="playSong('${song.url.replace(/'/g, "\\'")}', '${song.name.replace(/'/g, "\\'")}', '${song.artist.replace(/'/g, "\\'")}', '${mood}')">
                                        <i class="fas fa-play"></i> Play
                                    </button>
                                    <button class="btn btn-sm add-to-fav-btn" style="background-color: ${moodColor}; color: white;" onclick="addToFavorites('${song.name.replace(/'/g, "\\'")}', '${song.artist.replace(/'/g, "\\'")}', '${song.url.replace(/'/g, "\\'")}')">
                                        <i class="fas fa-heart"></i> Add to Favorites
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '<p>No songs available for this mood.</p>';
        }

        async function searchSongs() {
            const query = document.getElementById('song-search').value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            // Clear mood selection
            activeMood = null;
            document.querySelectorAll('.mood-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('song-display').innerHTML = '';

            try {
                const response = await fetch('/search_youtube_songs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const data = await response.json();
                const songs = data.songs || [];

                // Render search results
                const searchResults = document.getElementById('song-search-results');
                searchResults.innerHTML = songs.length ? `
                    <h6>Search Results</h6>
                    <div class="horizontal-scroll">
                        ${songs.slice(0, 5).map(song => `
                            <div class="card song-card">
                                <img src="${song.image}" alt="${song.name}" class="card-img-top">
                                <div class="song-card-body">
                                    <div class="song-title">${song.name}</div>
                                    <div class="song-artist">${song.artist}</div>
                                    <div class="song-actions">
                                        <button class="btn btn-sm play-btn" style="background-color: #6c757d; color: white;" data-bs-toggle="modal" data-bs-target="#videoModal" data-video-url="${song.url.replace(/'/g, "\\'")}" onclick="playSong('${song.url.replace(/'/g, "\\'")}', '${song.name.replace(/'/g, "\\'")}', '${song.artist.replace(/'/g, "\\'")}', 'search')">
                                            <i class="fas fa-play"></i> Play
                                        </button>
                                        <button class="btn btn-sm add-to-fav-btn" style="background-color: #6c757d; color: white;" onclick="addToFavorites('${song.name.replace(/'/g, "\\'")}', '${song.artist.replace(/'/g, "\\'")}', '${song.url.replace(/'/g, "\\'")}')">
                                            <i class="fas fa-heart"></i> Add to Favorites
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : '<p>No songs found.</p>';
            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('song-search-results').innerHTML = '<p>Error searching songs.</p>';
            }
        }

        async function addToFavorites(title, artist, url) {
            try {
                const response = await fetch('/add_to_favorites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, artist, url })
                });
                const data = await response.json();
                alert(data.message || data.error);
            } catch (error) {
                alert('Error adding song to favorites');
            }
        }

        async function playSong(url, title, artist, mood) {
            const videoId = getYouTubeVideoId(url);
            if (!videoId) {
                alert('Invalid YouTube URL');
                return;
            }

            // Show video in modal
            const youtubePlayer = document.getElementById('youtubePlayer');
            const errorMessage = document.getElementById('errorMessage');
            youtubePlayer.classList.remove('d-none');
            errorMessage.classList.add('d-none');
            youtubePlayer.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;

            // Record song in history
            try {
                const historyResponse = await fetch('/record-played-song', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mood, song_title: title, artist, url })
                });
                const historyData = await historyResponse.json();
                if (!historyData.success) {
                    console.error('Failed to record song in history:', historyData.error);
                }
            } catch (error) {
                console.error('Play song error:', error);
            }
        }

        // Function to extract YouTube video ID from URL
        function getYouTubeVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        // Video modal handling
        document.addEventListener('DOMContentLoaded', () => {
            const videoModal = document.getElementById('videoModal');
            videoModal.addEventListener('hidden.bs.modal', () => {
                const youtubePlayer = document.getElementById('youtubePlayer');
                const errorMessage = document.getElementById('errorMessage');
                youtubePlayer.src = '';
                youtubePlayer.classList.remove('d-none');
                errorMessage.classList.add('d-none');
            });
        });
    </script>
</body>
</html>